{% extends 'base.html' %}

{% block title %}
    | Checkout
{% endblock %}

{% block content %}
    <div class="min-vh-100">
        <div class="container d-flex justify-content-center my-2">
            {% if cart.contains_physical %}
                <h1>Please confirm your order and contact details below.</h1>
            {% else %}
                <h1>Please confirm your order below.</h1>
            {% endif %}
        </div>
        <div class="container">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th scope="col">Item</th>
                    <th scope="col">Quantity x Price</th>
                    <th scope="col">Total</th>
                </tr>
                </thead>
                <tbody>
                {% for item in cart %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td>{{ item.quantity }} x {{ item.price }}</td>
                        <td>${{ item.total_price|floatformat:2 }}</td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                <tr>
                    <td><strong>Total</strong></td>
                    <td></td>
                    <td><strong>${{ cart.get_total_price }}</strong></td>
                </tr>
                {% if cart.coupon %}
                    <tr>
                        <td>Discount</td>
                        <td>"{{ cart.coupon.code }}" ({{ cart.coupon.discount }}% off)</td>
                        <td class="text-danger"><strong>-${{ cart.get_discount|floatformat:2 }}</strong></td>
                    </tr>
                    <tr>
                        <td>Total after discount</td>
                        <td></td>
                        <td class="neg"><strong>${{ cart.get_total_price_after_discount|floatformat:2 }}</strong></td>
                    </tr>
                {% endif %}
                </tfoot>
            </table>
        </div>

        <div class="container my-5">
            <div class="row">
                <div class="col-lg-6">
                    <h3 class="text-center">Contact Details</h3>
                    <form action="" class="needs-validation" method="POST">
                        {% csrf_token %}
                        {{ create_order_form }}
                    </form>
                </div>
                <div class="col-lg-6">
                    <h3 class="text-center mb-3">Pay with Paypal</h3>
                    <div class="box-element" id="payment-info" class="hidden">
                        <!-- Set up a container element for the button -->
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-start my-5">
                <a href="{% url 'cart:cart_detail' %}" class="btn btn-secondary">Back to Cart</a>
            </div>
        </div>

        {#        {% if cart.contains_physical %}#}
        {# Show form to get mailing address. #}
        {#            <div class="container my-5">#}
        {#                <h3 class="text-center">Mailing Details</h3>#}
        {#                <form action="" class="needs-validation" method="POST">#}
        {#                    {% csrf_token %}#}
        {#                    {{ form }}#}
        {#                    <div class="d-flex justify-content-between my-5">#}
        {#                        <a href="{% url 'cart:cart_detail' %}" class="btn btn-secondary">Back to Cart</a>#}
        {#                        <input type="submit" class="btn btn-primary" value="To Payment">#}
        {#                    </div>#}
        {#                </form>#}
        {#            </div>#}
        {#        {% else %}#}
        {# display buttons. #}
        {#            <div class="d-flex justify-content-between my-5">#}
        {##}
        {#                <a href="{% url 'cart:cart_detail' %}" class="btn btn-secondary">Back to Cart</a>#}
        {#            </div>#}
        {#        {% endif %}#}
    </div>
    <!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AdNZlEGk9DRXnyqxHrX1TtGXnZG6waft_BR1h29ZyFa9rznlSy0n_i7sdD36L_npPX30w-owj0hHt4ds&currency=USD"></script>

    <script>
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            style: {
                color: 'blue',
                shape: 'pill',
                label: 'pay',
                height: 40
            },
            {# TODO call #}
            // Call your server to set up the transaction
            createOrder: function(data, actions) {

                return fetch('/demo/checkout/api/paypal/order/create/', {
                    method: 'post'
                }).then(function(res) {
                    return res.json();
                }).then(function(orderData) {
                    return orderData.id;
                });
            },

            // Call your server to finalize the transaction
            onApprove: function(data, actions) {
                return fetch('/demo/checkout/api/paypal/order/' + data.orderID + '/capture/', {
                    method: 'post'
                }).then(function (res) {
                    return res.json();
                }).then(function (orderData) {
                    // Three cases to handle:
                    //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                    //   (2) Other non-recoverable errors -> Show a failure message
                    //   (3) Successful transaction -> Show confirmation or thank you

                    // This example reads a v2/checkout/orders capture response, propagated from the server
                    // You could use a different API or structure for your 'orderData'
                    var errorDetail = Array.isArray(orderData.details) && orderData.details[0];

                    if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                        return actions.restart(); // Recoverable state, per:
                        // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
                    }

                    if (errorDetail) {
                        var msg = 'Sorry, your transaction could not be processed.';
                        if (errorDetail.description) msg += '\n\n' + errorDetail.description;
                        if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
                        return alert(msg); // Show a failure message
                    }

                    // Show a success message
                    alert('Transaction completed by ' + orderData.payer.name.given_name);
                });
            }

        }).render('#paypal-button-container');
    </script>
{% endblock %}
